{% if form_template %}
<div class="space-y-5" id="intakeFormFields">
    <!-- Form header -->
    <div class="flex items-center gap-2 pb-3 border-b border-gray-100 dark:border-slate-700">
        <i class="fa-solid fa-clipboard-list text-primary-500"></i>
        <div>
            <h3 class="font-bold text-gray-900 dark:text-white">{{ form_template.display_title }}</h3>
            {% if form_template.description %}
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">{{ form_template.description }}</p>
            {% endif %}
        </div>
    </div>

    {% for q in questions %}
    <div class="space-y-2 intake-question" data-question-id="{{ q.id }}" id="question-{{ q.id }}">
        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
            {{ q.display_text }}
            {% if q.is_required %}
            <span class="text-red-500 mr-1">*</span>
            {% else %}
            <span class="text-gray-400 text-xs font-normal">(اختياري)</span>
            {% endif %}
        </label>

        {% if q.help_text_content %}
        <p class="text-xs text-gray-400 dark:text-gray-500">{{ q.help_text_content }}</p>
        {% endif %}

        {% if q.field_type == "TEXT" %}
        <input type="text" name="intake_{{ q.id }}" placeholder="{{ q.placeholder }}"
               class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors text-sm"
               {% if q.is_required %}required{% endif %}>

        {% elif q.field_type == "TEXTAREA" %}
        <textarea name="intake_{{ q.id }}" rows="3" placeholder="{{ q.placeholder }}"
                  class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors text-sm resize-none"
                  {% if q.is_required %}required{% endif %}></textarea>

        {% elif q.field_type == "SELECT" %}
        <select name="intake_{{ q.id }}" data-source-question="{{ q.id }}"
                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors text-sm"
                {% if q.is_required %}required{% endif %}>
            <option value="">-- اختر --</option>
            {% for choice in q.choices %}
            <option value="{{ choice }}">{{ choice }}</option>
            {% endfor %}
        </select>

        {% elif q.field_type == "MULTISELECT" %}
        <div class="space-y-2">
            {% for choice in q.choices %}
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-slate-600 hover:border-primary-300 dark:hover:border-primary-700 cursor-pointer transition-colors bg-white dark:bg-slate-700/50">
                <input type="checkbox" name="intake_{{ q.id }}" value="{{ choice }}" data-source-question="{{ q.id }}"
                       class="w-4 h-4 text-primary-500 focus:ring-primary-500 rounded border-gray-300 dark:border-slate-500">
                <span class="text-sm text-gray-800 dark:text-gray-200">{{ choice }}</span>
            </label>
            {% endfor %}
        </div>

        {% elif q.field_type == "CHECKBOX" %}
        <div class="flex items-center gap-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-slate-600 hover:border-primary-300 dark:hover:border-primary-700 cursor-pointer transition-colors bg-white dark:bg-slate-700/50 flex-1">
                <input type="radio" name="intake_{{ q.id }}" value="نعم" data-source-question="{{ q.id }}"
                       class="w-4 h-4 text-primary-500 focus:ring-primary-500 border-gray-300 dark:border-slate-500"
                       {% if q.is_required %}required{% endif %}>
                <span class="text-sm text-gray-800 dark:text-gray-200 font-medium">نعم</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-slate-600 hover:border-primary-300 dark:hover:border-primary-700 cursor-pointer transition-colors bg-white dark:bg-slate-700/50 flex-1">
                <input type="radio" name="intake_{{ q.id }}" value="لا" data-source-question="{{ q.id }}"
                       class="w-4 h-4 text-primary-500 focus:ring-primary-500 border-gray-300 dark:border-slate-500">
                <span class="text-sm text-gray-800 dark:text-gray-200 font-medium">لا</span>
            </label>
        </div>

        {% elif q.field_type == "DATE" %}
        <input type="date" name="intake_{{ q.id }}"
               class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors text-sm"
               {% if q.is_required %}required{% endif %}>

        {% elif q.field_type == "FILE" %}
        <div class="file-upload-container" data-question-id="{{ q.id }}"
             {% if q.max_file_size_mb %}data-max-size-mb="{{ q.max_file_size_mb }}"{% endif %}
             {% if q.allowed_extensions %}data-allowed-ext="{{ q.allowed_extensions|join:"," }}"{% endif %}>
            <label for="file_{{ q.id }}"
                   class="flex flex-col items-center justify-center w-full p-4 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-lg cursor-pointer hover:border-primary-400 dark:hover:border-primary-500 transition-colors bg-white dark:bg-slate-700/30">
                <i class="fa-solid fa-cloud-arrow-up text-gray-400 dark:text-gray-500 text-2xl mb-2"></i>
                <span class="text-sm text-gray-500 dark:text-gray-400">اضغط لاختيار ملف</span>
                {% if q.allowed_extensions %}
                <span class="text-xs text-gray-400 mt-1">الصيغ المسموحة: {{ q.allowed_extensions|join:", " }}</span>
                {% endif %}
                {% if q.max_file_size_mb %}
                <span class="text-xs text-gray-400">الحد الأقصى: {{ q.max_file_size_mb }} ميغابايت</span>
                {% endif %}
            </label>
            <input type="file" name="intake_{{ q.id }}" id="file_{{ q.id }}"
                   {% if q.allowed_extensions %}accept="{% for ext in q.allowed_extensions %}.{{ ext }}{% if not forloop.last %},{% endif %}{% endfor %}"{% endif %}
                   class="hidden" multiple
                   {% if q.is_required %}data-required="true"{% endif %}>
            <!-- File info / error shown by JS -->
            <div id="file-info-{{ q.id }}" class="mt-2 hidden">
                <div class="flex items-center gap-2 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 p-2 rounded-lg text-sm file-success hidden">
                    <i class="fa-solid fa-check-circle"></i>
                    <span class="file-name truncate"></span>
                    <span class="text-xs text-green-500 file-size"></span>
                </div>
                <div class="flex items-center gap-2 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-2 rounded-lg text-sm file-error hidden">
                    <i class="fa-solid fa-circle-exclamation"></i>
                    <span class="error-msg"></span>
                </div>
            </div>
        </div>

        {% elif q.field_type == "DATED_FILES" %}
        <div class="dated-files-widget" data-question-id="{{ q.id }}" data-max-groups="7" data-max-per-group="5"
             {% if q.max_file_size_mb %}data-max-size-mb="{{ q.max_file_size_mb }}"{% endif %}
             {% if q.allowed_extensions %}data-allowed-ext="{{ q.allowed_extensions|join:"," }}"{% endif %}>
            <input type="hidden" name="intake_dfile_count_{{ q.id }}" value="0" class="dfw-count">
            <div class="dfw-groups space-y-3"></div>
            <button type="button" class="dfw-add-btn mt-3 w-full flex items-center justify-center gap-2 py-2.5 px-4 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-lg text-sm text-gray-500 dark:text-gray-400 hover:border-primary-400 hover:text-primary-500 transition-colors">
                <i class="fa-solid fa-plus"></i>
                إضافة مجموعة ملفات بتاريخ
            </button>
            <p class="text-xs text-gray-400 mt-1">
                الحد الأقصى: 7 مجموعات، كل مجموعة حتى 5 ملفات
                {% if q.max_file_size_mb %} · {{ q.max_file_size_mb }} MB لكل ملف{% endif %}
            </p>
        </div>

        {% endif %}
    </div>
    {% endfor %}

    <!-- Reason / medical description (always shown) -->
    <div class="pt-3 border-t border-gray-100 dark:border-slate-700">
        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
            وصف الحالة الطبية <span class="text-gray-400 text-xs font-normal">(اختياري)</span>
        </label>
        <textarea name="reason" rows="3" maxlength="1000" placeholder="صف حالتك الطبية أو سبب زيارتك باختصار..."
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors resize-none text-sm"></textarea>
        <p class="text-xs text-gray-400 mt-1">الحد الأقصى 1000 حرف</p>
    </div>
</div>

<!-- Dated Files Widget JS -->
<script>
(function() {
    function initDFW(widget) {
        var qId = widget.dataset.questionId;
        var maxGroups = parseInt(widget.dataset.maxGroups) || 7;
        var maxPerGroup = parseInt(widget.dataset.maxPerGroup) || 5;
        var maxMb = widget.dataset.maxSizeMb ? parseFloat(widget.dataset.maxSizeMb) : null;
        var allowedRaw = widget.dataset.allowedExt || '';
        var allowed = allowedRaw ? allowedRaw.split(',').map(function(e){return e.trim().toLowerCase().replace(/^\./,'');}) : [];
        var container = widget.querySelector('.dfw-groups');
        var addBtn = widget.querySelector('.dfw-add-btn');
        var countInput = widget.querySelector('.dfw-count');
        var groupCount = 0;
        var todayStr = new Date().toISOString().split('T')[0];

        function updateCount() { countInput.value = groupCount; }

        function addGroup(prefillDate) {
            if (groupCount >= maxGroups) return;
            var gi = groupCount;
            groupCount++;
            updateCount();

            var div = document.createElement('div');
            div.className = 'dfw-group rounded-lg border border-gray-200 dark:border-slate-600 p-3 space-y-2 bg-white dark:bg-slate-700/30';
            div.dataset.groupIndex = gi;

            var acceptAttr = allowed.length ? ' accept="' + allowed.map(function(e){return '.'+e;}).join(',') + '"' : '';
            var dateVal = prefillDate || '';

            div.innerHTML =
                '<div class="flex items-center justify-between gap-2">' +
                    '<div class="flex items-center gap-2 flex-1">' +
                        '<i class="fa-solid fa-calendar-day text-primary-400 text-sm"></i>' +
                        '<input type="date" name="intake_dfile_date_' + qId + '_g' + gi + '" value="' + dateVal + '" required max="' + todayStr + '" ' +
                            'class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 text-sm">' +
                    '</div>' +
                    '<button type="button" class="dfw-remove-btn text-red-400 hover:text-red-600 transition-colors p-1" title="حذف المجموعة">' +
                        '<i class="fa-solid fa-trash-can text-sm"></i>' +
                    '</button>' +
                '</div>' +
                '<label class="flex flex-col items-center justify-center w-full py-3 border-2 border-dashed border-gray-200 dark:border-slate-600 rounded-lg cursor-pointer hover:border-primary-400 transition-colors bg-gray-50 dark:bg-slate-800/30">' +
                    '<i class="fa-solid fa-cloud-arrow-up text-gray-300 dark:text-slate-500 text-lg mb-1"></i>' +
                    '<span class="text-xs text-gray-400">اختر الملفات (حتى ' + maxPerGroup + ')</span>' +
                    '<input type="file" name="intake_dfile_' + qId + '_g' + gi + '" class="hidden" multiple' + acceptAttr + '>' +
                '</label>' +
                '<div class="dfw-file-feedback text-xs space-y-0.5"></div>';

            container.appendChild(div);

            // Remove handler
            div.querySelector('.dfw-remove-btn').addEventListener('click', function() {
                div.remove();
                rebuildIndices();
            });

            // File validation
            var fileInput = div.querySelector('input[type="file"]');
            var feedback = div.querySelector('.dfw-file-feedback');
            fileInput.addEventListener('change', function() {
                feedback.innerHTML = '';
                var valid = true;
                var fileArr = Array.from(fileInput.files);
                if (fileArr.length > maxPerGroup) {
                    feedback.innerHTML = '<p class="text-red-500"><i class="fa-solid fa-xmark ml-1"></i>الحد الأقصى ' + maxPerGroup + ' ملفات</p>';
                    fileInput.value = '';
                    return;
                }
                fileArr.forEach(function(f) {
                    var ext = f.name.split('.').pop().toLowerCase();
                    var sizeMB = (f.size / 1024 / 1024).toFixed(1);
                    if (allowed.length && allowed.indexOf(ext) < 0) {
                        feedback.innerHTML += '<p class="text-red-500"><i class="fa-solid fa-xmark ml-1"></i>صيغة غير مسموحة: .' + ext + '</p>';
                        valid = false;
                    } else if (maxMb && f.size > maxMb * 1024 * 1024) {
                        feedback.innerHTML += '<p class="text-red-500"><i class="fa-solid fa-xmark ml-1"></i>' + f.name + ' يتجاوز ' + maxMb + ' MB</p>';
                        valid = false;
                    } else {
                        feedback.innerHTML += '<p class="text-green-600"><i class="fa-solid fa-check ml-1"></i>' + f.name + ' (' + sizeMB + ' MB)</p>';
                    }
                });
                if (!valid) fileInput.value = '';
            });

            if (groupCount >= maxGroups) addBtn.style.display = 'none';
        }

        function rebuildIndices() {
            var groups = container.querySelectorAll('.dfw-group');
            groupCount = groups.length;
            updateCount();
            groups.forEach(function(g, i) {
                g.dataset.groupIndex = i;
                var dateInput = g.querySelector('input[type="date"]');
                if (dateInput) dateInput.name = 'intake_dfile_date_' + qId + '_g' + i;
                var fileInput = g.querySelector('input[type="file"]');
                if (fileInput) fileInput.name = 'intake_dfile_' + qId + '_g' + i;
            });
            addBtn.style.display = groupCount >= maxGroups ? 'none' : '';
        }

        addBtn.addEventListener('click', function() { addGroup(''); });
    }

    function initAllDFW() {
        document.querySelectorAll('.dated-files-widget').forEach(function(w) {
            if (!w.dataset.dfwInit) {
                w.dataset.dfwInit = '1';
                initDFW(w);
            }
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAllDFW);
    } else { initAllDFW(); }
    document.addEventListener('htmx:afterSwap', initAllDFW);
    document.addEventListener('htmx:load', initAllDFW);
})();
</script>

<!-- Conditional Rules (client-side) -->
{% if rules_json and rules_json != "[]" %}
<script>
(function() {
    var rules = {{ rules_json|safe }};
    if (!rules || !rules.length) return;

    var showTargets = new Set();
    rules.forEach(function(r) { if (r.action === 'SHOW') showTargets.add(r.target_question_id); });

    showTargets.forEach(function(qId) {
        var el = document.getElementById('question-' + qId);
        if (el) el.style.display = 'none';
    });

    function getVal(qId) {
        var r = document.querySelector('input[name="intake_' + qId + '"]:checked');
        if (r) return r.value;
        var s = document.querySelector('select[name="intake_' + qId + '"]');
        if (s) return s.value;
        var t = document.querySelector('[name="intake_' + qId + '"]');
        if (t && t.type !== 'checkbox' && t.type !== 'radio') return t.value || '';
        var chks = document.querySelectorAll('input[name="intake_' + qId + '"]:checked');
        return chks.length ? Array.from(chks).map(function(c) { return c.value; }) : '';
    }

    function evaluate() {
        showTargets.forEach(function(qId) {
            var el = document.getElementById('question-' + qId);
            if (el) el.style.display = 'none';
        });
        rules.forEach(function(r) {
            var v = getVal(r.source_question_id), match = false;
            if (r.operator === 'EQUALS') match = v === r.expected_value;
            else if (r.operator === 'NOT_EQUALS') match = v !== r.expected_value;
            else if (r.operator === 'CONTAINS') match = Array.isArray(v) ? v.indexOf(r.expected_value) >= 0 : (v||'').indexOf(r.expected_value) >= 0;
            else if (r.operator === 'IN') match = Array.isArray(v) ? v.indexOf(r.expected_value) >= 0 : (v||'').indexOf(r.expected_value) >= 0;
            var tgt = document.getElementById('question-' + r.target_question_id);
            if (!tgt) return;
            if (match) { if (r.action === 'SHOW') tgt.style.display = ''; else tgt.style.display = 'none'; }
        });
    }

    var c = document.getElementById('intakeFormFields');
    if (c) { c.addEventListener('change', evaluate); c.addEventListener('input', evaluate); }
    evaluate();
})();
</script>
{% endif %}

{% elif no_form %}
<div>
    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
        وصف الحالة الطبية <span class="text-gray-400 text-xs font-normal">(اختياري)</span>
    </label>
    <textarea name="reason" rows="3" maxlength="1000" placeholder="صف حالتك الطبية أو سبب زيارتك باختصار..."
              class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors resize-none text-sm"></textarea>
    <p class="text-xs text-gray-400 mt-1">الحد الأقصى 1000 حرف</p>
</div>

{% else %}
<p class="text-gray-400 dark:text-gray-500 text-sm">اختر طبيباً ونوع الموعد لعرض النموذج.</p>
{% endif %}