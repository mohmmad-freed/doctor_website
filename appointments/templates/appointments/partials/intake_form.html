{% if form_template %}
<div class="space-y-5" id="intakeFormFields">
    <!-- Form header -->
    <div class="flex items-center gap-2 pb-3 border-b border-gray-100 dark:border-slate-700">
        <i class="fa-solid fa-clipboard-list text-primary-500"></i>
        <div>
            <h3 class="font-bold text-gray-900 dark:text-white">{{ form_template.display_title }}</h3>
            {% if form_template.description %}
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">{{ form_template.description }}</p>
            {% endif %}
        </div>
    </div>

    {% for q in questions %}
    <div class="space-y-2 intake-question" data-question-id="{{ q.id }}" id="question-{{ q.id }}">
        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
            {{ q.display_text }}
            {% if q.is_required %}
            <span class="text-red-500 mr-1">*</span>
            {% else %}
            <span class="text-gray-400 text-xs font-normal">(اختياري)</span>
            {% endif %}
        </label>

        {% if q.help_text_content %}
        <p class="text-xs text-gray-400 dark:text-gray-500">{{ q.help_text_content }}</p>
        {% endif %}

        {% if q.field_type == "TEXT" %}
        <input type="text" name="intake_{{ q.id }}" placeholder="{{ q.placeholder }}"
               class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors text-sm"
               {% if q.is_required %}required{% endif %}>

        {% elif q.field_type == "TEXTAREA" %}
        <textarea name="intake_{{ q.id }}" rows="3" placeholder="{{ q.placeholder }}"
                  class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors text-sm resize-none"
                  {% if q.is_required %}required{% endif %}></textarea>

        {% elif q.field_type == "SELECT" %}
        <select name="intake_{{ q.id }}" data-source-question="{{ q.id }}"
                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors text-sm"
                {% if q.is_required %}required{% endif %}>
            <option value="">-- اختر --</option>
            {% for choice in q.choices %}
            <option value="{{ choice }}">{{ choice }}</option>
            {% endfor %}
        </select>

        {% elif q.field_type == "MULTISELECT" %}
        <div class="space-y-2">
            {% for choice in q.choices %}
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-slate-600 hover:border-primary-300 dark:hover:border-primary-700 cursor-pointer transition-colors bg-white dark:bg-slate-700/50">
                <input type="checkbox" name="intake_{{ q.id }}" value="{{ choice }}" data-source-question="{{ q.id }}"
                       class="w-4 h-4 text-primary-500 focus:ring-primary-500 rounded border-gray-300 dark:border-slate-500">
                <span class="text-sm text-gray-800 dark:text-gray-200">{{ choice }}</span>
            </label>
            {% endfor %}
        </div>

        {% elif q.field_type == "CHECKBOX" %}
        <div class="flex items-center gap-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-slate-600 hover:border-primary-300 dark:hover:border-primary-700 cursor-pointer transition-colors bg-white dark:bg-slate-700/50 flex-1">
                <input type="radio" name="intake_{{ q.id }}" value="نعم" data-source-question="{{ q.id }}"
                       class="w-4 h-4 text-primary-500 focus:ring-primary-500 border-gray-300 dark:border-slate-500"
                       {% if q.is_required %}required{% endif %}>
                <span class="text-sm text-gray-800 dark:text-gray-200 font-medium">نعم</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-slate-600 hover:border-primary-300 dark:hover:border-primary-700 cursor-pointer transition-colors bg-white dark:bg-slate-700/50 flex-1">
                <input type="radio" name="intake_{{ q.id }}" value="لا" data-source-question="{{ q.id }}"
                       class="w-4 h-4 text-primary-500 focus:ring-primary-500 border-gray-300 dark:border-slate-500">
                <span class="text-sm text-gray-800 dark:text-gray-200 font-medium">لا</span>
            </label>
        </div>

        {% elif q.field_type == "DATE" %}
        <input type="date" name="intake_{{ q.id }}"
               class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors text-sm"
               {% if q.is_required %}required{% endif %}>

        {% elif q.field_type == "FILE" %}
        {# ── Multi-photo upload widget: max 5 images, 5 MB each ── #}
        <div class="multi-file-upload" id="mfu-{{ q.id }}" data-question-id="{{ q.id }}" data-max-files="5" data-max-mb="5">

            {# ── Drop Zone ── #}
            <div class="mfu-dropzone" id="mfu-dz-{{ q.id }}" role="button" tabindex="0"
                 aria-label="منطقة رفع الصور">
                <i class="fa-solid fa-images mfu-dz-icon"></i>
                <p class="mfu-dz-title">اسحب الصور هنا أو <span class="mfu-dz-link">اضغط للاختيار</span></p>
                <p class="mfu-dz-hint">
                    صور فقط (JPG · PNG · WEBP) &nbsp;·&nbsp; حد أقصى <strong>5 صور</strong> &nbsp;·&nbsp; <strong>5 MB</strong> لكل صورة
                </p>
                <input type="file" name="intake_{{ q.id }}" id="file_{{ q.id }}"
                       accept="image/jpeg,image/png,image/webp,.jpg,.jpeg,.png,.webp"
                       multiple
                       class="mfu-hidden-input"
                       {% if q.is_required %}data-required="true"{% endif %}>
            </div>

            {# ── Count badge ── #}
            <div class="mfu-count-row hidden" id="mfu-count-{{ q.id }}">
                <span class="mfu-count-badge">
                    <i class="fa-solid fa-photo-film"></i>
                    <span class="mfu-count-num">0</span> / 5 صور
                </span>
                <button type="button" class="mfu-clear-all" data-target="{{ q.id }}">
                    <i class="fa-solid fa-trash-can"></i> مسح الكل
                </button>
            </div>

            {# ── Thumbnail grid ── #}
            <div class="mfu-previews" id="mfu-previews-{{ q.id }}"></div>

            {# ── Error banner ── #}
            <div class="mfu-error hidden" id="mfu-error-{{ q.id }}">
                <i class="fa-solid fa-circle-exclamation"></i>
                <span class="mfu-error-msg"></span>
            </div>
        </div>

        {# ── Scoped styles (injected once via JS guard) ── #}
        <style id="mfu-styles" data-injected="false">
        .multi-file-upload { direction: rtl; }

        /* Drop zone */
        .mfu-dropzone {
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 6px;
            padding: 28px 16px;
            border: 2px dashed #cbd5e1;
            border-radius: 14px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            cursor: pointer;
            transition: border-color .25s, background .25s, box-shadow .25s;
            outline: none;
        }
        .dark .mfu-dropzone {
            border-color: #475569;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        .mfu-dropzone:hover, .mfu-dropzone:focus-visible, .mfu-dropzone.mfu-drag-over {
            border-color: #6366f1;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            box-shadow: 0 0 0 4px rgba(99,102,241,.12);
        }
        .dark .mfu-dropzone:hover, .dark .mfu-dropzone:focus-visible, .dark .mfu-dropzone.mfu-drag-over {
            border-color: #818cf8;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
        }
        .mfu-dz-icon { font-size: 2rem; color: #94a3b8; transition: color .25s, transform .25s; }
        .mfu-dropzone:hover .mfu-dz-icon { color: #6366f1; transform: translateY(-3px); }
        .mfu-dz-title { font-size: .875rem; font-weight: 600; color: #475569; margin: 0; }
        .dark .mfu-dz-title { color: #94a3b8; }
        .mfu-dz-link { color: #6366f1; text-decoration: underline; }
        .mfu-dz-hint { font-size: .75rem; color: #94a3b8; margin: 0; text-align: center; }
        .mfu-hidden-input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }

        /* Count row */
        .mfu-count-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-top: 10px;
        }
        .mfu-count-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 12px; border-radius: 20px;
            background: #e0e7ff; color: #4338ca;
            font-size: .78rem; font-weight: 700;
        }
        .dark .mfu-count-badge { background: #312e81; color: #a5b4fc; }
        .mfu-clear-all {
            font-size: .78rem; color: #ef4444; background: none; border: none;
            cursor: pointer; display: flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 8px;
            transition: background .2s;
        }
        .mfu-clear-all:hover { background: #fee2e2; }
        .dark .mfu-clear-all:hover { background: #450a0a; }

        /* Thumbnail grid */
        .mfu-previews {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .mfu-thumb {
            position: relative; border-radius: 10px; overflow: hidden;
            aspect-ratio: 1; background: #f1f5f9;
            box-shadow: 0 2px 8px rgba(0,0,0,.08);
            animation: mfu-pop .25s cubic-bezier(.34,1.56,.64,1) both;
        }
        @keyframes mfu-pop { from { opacity: 0; transform: scale(.7); } to { opacity: 1; transform: scale(1); } }
        .mfu-thumb img {
            width: 100%; height: 100%; object-fit: cover; display: block;
        }
        .mfu-thumb-remove {
            position: absolute; top: 4px; left: 4px;
            width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: rgba(15,23,42,.65);
            color: #fff; border: none; cursor: pointer; font-size: .65rem;
            transition: background .2s, transform .2s;
        }
        .mfu-thumb-remove:hover { background: #ef4444; transform: scale(1.15); }
        .mfu-thumb-name {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 3px 5px;
            background: rgba(15,23,42,.55);
            font-size: .6rem; color: #e2e8f0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            text-align: center;
        }

        /* Error */
        .mfu-error {
            display: flex; align-items: center; gap: 8px;
            margin-top: 8px; padding: 8px 12px;
            background: #fef2f2; border: 1px solid #fca5a5; border-radius: 10px;
            color: #dc2626; font-size: .8rem;
        }
        .dark .mfu-error { background: rgba(239,68,68,.1); border-color: #7f1d1d; color: #f87171; }
        </style>

        {% endif %}
    </div>
    {% endfor %}

    <!-- Reason / medical description (always shown) -->
    <div class="pt-3 border-t border-gray-100 dark:border-slate-700">
        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
            وصف الحالة الطبية <span class="text-gray-400 text-xs font-normal">(اختياري)</span>
        </label>
        <textarea name="reason" rows="3" maxlength="1000" placeholder="صف حالتك الطبية أو سبب زيارتك باختصار..."
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors resize-none text-sm"></textarea>
        <p class="text-xs text-gray-400 mt-1">الحد الأقصى 1000 حرف</p>
    </div>
</div>

<!-- Multi-File Upload Widget JS -->
<script>
(function () {
    var MAX_FILES = 5;
    var MAX_MB    = 5;
    var MAX_BYTES = MAX_MB * 1024 * 1024;
    var ALLOWED   = ['image/jpeg', 'image/png', 'image/webp'];

    function initMFU(widget) {
        var qId      = widget.dataset.questionId;
        var input    = widget.querySelector('.mfu-hidden-input');
        var dropzone = widget.querySelector('.mfu-dropzone');
        var previews = document.getElementById('mfu-previews-' + qId);
        var countRow = document.getElementById('mfu-count-' + qId);
        var countNum = countRow.querySelector('.mfu-count-num');
        var errorEl  = document.getElementById('mfu-error-' + qId);
        var errMsg   = errorEl.querySelector('.mfu-error-msg');
        var clearBtn = countRow.querySelector('.mfu-clear-all');

        var files = []; // array of File objects

        function showError(msg) {
            errMsg.textContent = msg;
            errorEl.classList.remove('hidden');
            setTimeout(function () { errorEl.classList.add('hidden'); }, 4000);
        }

        function syncInput() {
            var dt = new DataTransfer();
            files.forEach(function (f) { dt.items.add(f); });
            input.files = dt.files;
        }

        function renderPreviews() {
            previews.innerHTML = '';
            files.forEach(function (file, idx) {
                var thumb = document.createElement('div');
                thumb.className = 'mfu-thumb';
                var img = document.createElement('img');
                img.alt = file.name;
                var reader = new FileReader();
                reader.onload = function (e) { img.src = e.target.result; };
                reader.readAsDataURL(file);
                var nameEl = document.createElement('div');
                nameEl.className = 'mfu-thumb-name';
                nameEl.textContent = file.name;
                var removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'mfu-thumb-remove';
                removeBtn.setAttribute('aria-label', 'حذف الصورة');
                removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                removeBtn.addEventListener('click', function () {
                    files.splice(idx, 1);
                    syncInput();
                    refresh();
                });
                thumb.appendChild(img);
                thumb.appendChild(nameEl);
                thumb.appendChild(removeBtn);
                previews.appendChild(thumb);
            });
            countNum.textContent = files.length;
            if (files.length > 0) {
                countRow.classList.remove('hidden');
            } else {
                countRow.classList.add('hidden');
            }
        }

        function refresh() { renderPreviews(); syncInput(); }

        function addFiles(newFiles) {
            var added = 0;
            Array.from(newFiles).forEach(function (file) {
                if (files.length >= MAX_FILES) {
                    showError('الحد الأقصى ' + MAX_FILES + ' صور فقط.');
                    return;
                }
                if (ALLOWED.indexOf(file.type) === -1) {
                    showError('الصيغة غير مدعومة: ' + file.name + '. مسموح فقط JPG, PNG, WEBP.');
                    return;
                }
                if (file.size > MAX_BYTES) {
                    showError(file.name + ' أكبر من الحد المسموح (' + MAX_MB + ' MB).');
                    return;
                }
                files.push(file);
                added++;
            });
            if (added) refresh();
        }

        // Click to open file picker (the hidden input covers the drop zone)
        input.addEventListener('change', function () {
            addFiles(input.files);
            input.value = ''; // reset so same file can be re-added after removal
        });

        // Keyboard accessibility
        dropzone.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); }
        });

        // Drag & drop
        dropzone.addEventListener('dragover', function (e) {
            e.preventDefault(); dropzone.classList.add('mfu-drag-over');
        });
        dropzone.addEventListener('dragleave', function () {
            dropzone.classList.remove('mfu-drag-over');
        });
        dropzone.addEventListener('drop', function (e) {
            e.preventDefault();
            dropzone.classList.remove('mfu-drag-over');
            if (e.dataTransfer && e.dataTransfer.files.length) addFiles(e.dataTransfer.files);
        });

        // Clear all
        clearBtn.addEventListener('click', function () {
            files = [];
            syncInput();
            refresh();
        });

        // Required validation on form submit
        var form = widget.closest('form');
        if (form && input.dataset.required === 'true') {
            form.addEventListener('submit', function (e) {
                if (files.length === 0) {
                    e.preventDefault();
                    showError('يرجى رفع صورة واحدة على الأقل.');
                    dropzone.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, { capture: true });
        }
    }

    function initAll() {
        document.querySelectorAll('.multi-file-upload').forEach(function (w) {
            if (!w.dataset.mfuInit) {
                w.dataset.mfuInit = '1';
                initMFU(w);
            }
        });
    }

    // Run now and after HTMX / any dynamic injection
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAll);
    } else {
        initAll();
    }
    document.addEventListener('htmx:afterSwap', initAll);
    document.addEventListener('htmx:load',      initAll);
})();
</script>

<!-- Conditional Rules (client-side) -->
{% if rules_json and rules_json != "[]" %}
<script>
(function() {
    var rules = {{ rules_json|safe }};
    if (!rules || !rules.length) return;

    var showTargets = new Set();
    rules.forEach(function(r) { if (r.action === 'SHOW') showTargets.add(r.target_question_id); });

    showTargets.forEach(function(qId) {
        var el = document.getElementById('question-' + qId);
        if (el) el.style.display = 'none';
    });

    function getVal(qId) {
        var r = document.querySelector('input[name="intake_' + qId + '"]:checked');
        if (r) return r.value;
        var s = document.querySelector('select[name="intake_' + qId + '"]');
        if (s) return s.value;
        var t = document.querySelector('[name="intake_' + qId + '"]');
        if (t && t.type !== 'checkbox' && t.type !== 'radio') return t.value || '';
        var chks = document.querySelectorAll('input[name="intake_' + qId + '"]:checked');
        return chks.length ? Array.from(chks).map(function(c) { return c.value; }) : '';
    }

    function evaluate() {
        showTargets.forEach(function(qId) {
            var el = document.getElementById('question-' + qId);
            if (el) el.style.display = 'none';
        });
        rules.forEach(function(r) {
            var v = getVal(r.source_question_id), match = false;
            if (r.operator === 'EQUALS') match = v === r.expected_value;
            else if (r.operator === 'NOT_EQUALS') match = v !== r.expected_value;
            else if (r.operator === 'CONTAINS') match = Array.isArray(v) ? v.indexOf(r.expected_value) >= 0 : (v||'').indexOf(r.expected_value) >= 0;
            else if (r.operator === 'IN') match = Array.isArray(v) ? v.indexOf(r.expected_value) >= 0 : (v||'').indexOf(r.expected_value) >= 0;
            var tgt = document.getElementById('question-' + r.target_question_id);
            if (!tgt) return;
            if (match) { if (r.action === 'SHOW') tgt.style.display = ''; else tgt.style.display = 'none'; }
        });
    }

    var c = document.getElementById('intakeFormFields');
    if (c) { c.addEventListener('change', evaluate); c.addEventListener('input', evaluate); }
    evaluate();
})();
</script>
{% endif %}

{% elif no_form %}
<div>
    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
        وصف الحالة الطبية <span class="text-gray-400 text-xs font-normal">(اختياري)</span>
    </label>
    <textarea name="reason" rows="3" maxlength="1000" placeholder="صف حالتك الطبية أو سبب زيارتك باختصار..."
              class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors resize-none text-sm"></textarea>
    <p class="text-xs text-gray-400 mt-1">الحد الأقصى 1000 حرف</p>
</div>

{% else %}
<p class="text-gray-400 dark:text-gray-500 text-sm">اختر طبيباً ونوع الموعد لعرض النموذج.</p>
{% endif %}